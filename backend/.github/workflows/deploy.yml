name: CI/CD | Build and Deploy to Production VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend
  APP_DIR: "~/soroban-app"

jobs:
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Create frontend .env file
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> ./frontend/.env
          echo "VITE_STELLER_BACKEND=${{ secrets.VITE_STELLER_BACKEND }}" >> ./frontend/.env
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.FRONTEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy deployment file to VPS
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          source: "docker-compose.yml"
          target: ${{ env.APP_DIR }}

      - name: Deploy Application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e
            cd ${{ env.APP_DIR }}

            # Create the .env file from the GitHub secret
            echo "${{ secrets.ENV_FILE_CONTENT }}" > .env
            
            # Export image names for Docker Compose to use from the .env file
            export BACKEND_IMAGE=${{ env.BACKEND_IMAGE }}:latest
            export FRONTEND_IMAGE=${{ env.FRONTEND_IMAGE }}:latest
            
            # Log in to GitHub Container Registry
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Create persistent volume directories on the host if they don't exist
            sudo mkdir -p ./uploads ./certs ./vhost.d ./html ./acme
            # The 'node' user in the official Node image has UID 1000 and GID 1000.
            sudo chown -R 1000:1000 ./uploads

            # CRITICAL: Remove any existing vhost configs to prevent duplicates
            sudo rm -f ./vhost.d/aitt-backend.duckdns.org_location
            sudo rm -f ./vhost.d/aitt-backend.duckdns.org

            # Create NGINX vhost config for backend - increase upload size ONLY
            # DO NOT add CORS here if your backend already handles it
            cat > ./vhost.d/aitt-backend.duckdns.org_location << 'EOF'
            # Increase client body size for file uploads (50MB)
            client_max_body_size 50m;
            client_body_buffer_size 50m;
            proxy_request_buffering off;
            EOF

            # Fix certificate symlinks - USE FULLCHAIN.PEM
            if [ -f "./certs/aitt-transparency.com/fullchain.pem" ]; then
              sudo ln -sf ./aitt-transparency.com/fullchain.pem ./certs/aitt-transparency.com.crt 2>/dev/null || true
              sudo ln -sf ./aitt-transparency.com/key.pem ./certs/aitt-transparency.com.key 2>/dev/null || true
              sudo ln -sf ./aitt-transparency.com/chain.pem ./certs/aitt-transparency.com.chain.pem 2>/dev/null || true
            fi
            
            if [ -f "./certs/aitt-backend.duckdns.org/fullchain.pem" ]; then
              sudo ln -sf ./aitt-backend.duckdns.org/fullchain.pem ./certs/aitt-backend.duckdns.org.crt 2>/dev/null || true
              sudo ln -sf ./aitt-backend.duckdns.org/key.pem ./certs/aitt-backend.duckdns.org.key 2>/dev/null || true
              sudo ln -sf ./aitt-backend.duckdns.org/chain.pem ./certs/aitt-backend.duckdns.org.chain.pem 2>/dev/null || true
            fi

            # Check if nginx-proxy and acme-companion are already running
            NGINX_RUNNING=$(docker compose ps -q nginx-proxy 2>/dev/null | grep -v '^$' || echo "")
            ACME_RUNNING=$(docker compose ps -q acme-companion 2>/dev/null | grep -v '^$' || echo "")

            # Pull latest images for backend and frontend
            docker compose pull backend frontend

            # If SSL infrastructure is not running, start everything fresh
            if [ -z "$NGINX_RUNNING" ] || [ -z "$ACME_RUNNING" ]; then
              echo "Starting SSL infrastructure and application services..."
              docker compose down --remove-orphans
              docker compose up -d
            else
              # SSL infrastructure is running, only update app containers
              echo "SSL infrastructure running, updating only application containers..."
              docker compose up -d --no-deps --force-recreate backend frontend
              # Reload nginx to pick up any config changes
              docker exec nginx-proxy nginx -s reload 2>/dev/null || true
            fi
            
            echo "Deployment successful. Upload size limit set to 50MB, CORS handled by backend."